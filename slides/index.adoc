= Macarons: des cookies en mieux !
Julien Tanguy
v2.0-fr, 2017-10-20: Devfest 2017
:homepage: https://github.com/jtanguy/devfest-macaroons
:twitter: jutanguy
:github: jtanguy
:blog: https://jtanguy.cleverapps.io
:backend: revealjs
:copyright: CC BY 4.0
:hashtag: #macaroons
:stem: latexmath
:source-highlighter: highlightjs
:revealjsdir: reveal.js
:revealjs_display: flex
:revealjs_theme: valwin
:title-slide-background-image: images/macaroons.jpg

[.two-columns]
== `whoami`

image::images/jutanguy.jpg[]

[.align-left]
--
- Développeur
- link:https://www.valwin.fr[Valwin]

//

- https://twitter.com/{twitter}
- https://github.com/{github}
- {blog}
--

[NOTE.speaker]
====
Bonjour, je suis

- Julien
- Développeur chez Valwin
- en recherche d'un dev front
====

== Authentification vs Autorisation

____
Qui suis-je ?
____

[.fragment]
____
Qu'ai-je le droit de faire ?
____


[NOTE.speaker]
====
Quand on parle d'auth sur le net, on mélange souvent deux concepts:
- L'authentification, qui est le processus qui détermine qui suis-je, et
- L'autorisation, qui est le processus qui détermine ce que j'ai le droit de faire.

Dans cette présentation nous parlerons principalement d'autorisation.
====

== Exemple: Partage de fichiers

[.step]
- Système de fichiers dans le cloud
- Je veux partager un dossier à _Alice_
- _Alice_ veut repartager une partie de ce dossier à _Bob_

[NOTE.speaker]
====
Prenons un petit exemple de service dans lequel nous aimerions faire de l'autorisation.

On a un service de partage de fichiers, dans lequel je stocke toutes mes données.

Je souhaite partager un de mes dossiers à Alice, car on travaille ensemble sur un projet et elle me relit.

Je lui envoie un lien qui lui permet d'accéder au dossier en question et elle peut accéder aux fichiers.

Seulement Alice souhaite faire relire certains fichiers à Bob, mais certains fichiers dans le dossier sont sensibles.

Elle ne veut pas lui donner accès à tout le dossier, et est obligé de me redemander un lien pour le passer à Bob.
====

=== _Bearer tokens_

https://drive.google.com/open?id=197u0vRt8_VvTa0GaNknMRVQkm-Q

[NOTE.speaker]
====
Dans ce lien de partage de drive, on peut voir la partie `id`, qui représente quelque part ce qu'on appelle un _bearer token_, ou un badge d'accès à toute personne qui le possède.
====


== _Macaroons_

- Papier de recherche Google publié en 2014 <<pub41892>>

- _Bearer token_ avec une _signature_
- Restriction des accès avec des _caveats_

[NOTE.speaker]
====
====

== Anatomie d'un _macaroon_

- Secret
- Indentifiant,
- Url
- Signature

[NOTE.speaker]
====
====

== _Caveats_

____
Liste *ordonnée* de prédicats qui limitent l'autorité d'un _macaroon_
____

Deux types de _caveat_
- primaires (_first party_)
- tiers (_third party_)

[NOTE.speaker]
====
====

== _Caveats_ primaires

====
- `account = 123456`
- `file in ["accounts.pdf","bills.pdf"]`
- `time < 2017-05-18T14:45+02:00`
====

[NOTE.speaker]
====
====

=== Ajout

. Macaroon stem:[m] (secret, identifier, location)
. assertion stem:[\mathcal{A}] = `account = 123456`
. stem:[m].addFirstPartyCaveat(stem:[\mathcal{A}])
. Done.

[NOTE.speaker]
====
====

=== Vérification

====
- `account = 123456`
- `file in ["accounts.pdf","bills.pdf"]`
- `time < 2017-05-18T14:45+02:00`
====


[NOTE.speaker]
====
====


== _Caveats_ tiers

Prédicats externes non listés dans le _macaroon_.

====
- L'utilisateur doit être authentifié chez `auth.com` comme _Alice_
- L'utilisateur doit être authentifié comme _Bob_
====

[NOTE.speaker]
====
====

=== Ajout

[start=-3]
. Assertion stem:[\mathcal{A}] = 'user = Alice'
. Secret partagé stem:[\mathcal{S}]
. Envoi de stem:[\mathcal{A} + \mathcal{S}] à link:#[auth.com]
. On récupère l'identifiant stem:[\mathcal{id_{auth}}]
. Macaroon stem:[m] (secret, identifier, location)
. stem:[m].addThirdPartyCaveat(stem:[\mathcal{S}] ,stem:[\mathcal{id_{auth}}], link:#[auth.com])
. Done.

NOTE: _Le secret partagé n'est *pas* dans le macaron final_

[NOTE.speaker]
====
====

=== Vérification

Un _caveat_ tiers doit être _déchargé_ par un autre macaron.

[NOTE.speaker]
====
====

== Signature

La signature est recalculée à chaque fois que l'on rajoute un _caveat_.

[.step]
- stem:[sig_0 = HMAC(secret,identifier)];
- stem:[sig_1 = HMAC(sig_0, caveat_0)];
- stem:[sig_2 = HMAC(sig_1, caveat_1)];
- etc…

[NOTE.speaker]
====
====

== _Macaroons_ vs JWT

[NOTE.speaker]
====
====

=== Similitudes

[.step]
- Token
- Signature

[NOTE.speaker]
====
====

=== Différences

[frame=none, grid=none, options=header]
|===
| | _Macaroon_ | JWT

| Algo de hash | HMAC-SHA256  | Dans le JWT

| Donnée additionnelle | Caveats (soustractif) | Claims (additif)

| Délégation | Possible (client-side) | Impossible (nouveau JWT)
|===

[NOTE.speaker]
====
====

== Exemple: Partage de fichiers

- Accès aux fichiers grâce à des macarons
- On peut modifier et restreindre le partage

[NOTE.speaker]
====
====

=== Exemple

[.step]
. _Macaroon_ stem:[m_{julien}]
. `prefix = subfolder` -> stem:[m_{alice}]
. `mode = readonly` -> stem:[m_{bob}]

[NOTE.speaker]
====
====

== Autorisation dans un contexte microservices

image::images/cclogo.png[Clever Cloud, 200, 200, role=plain]

- Infrastructure immutable
- Microservices

[NOTE.speaker]
====
====

=== Gestion des caches de build

- Caches sauvegardés sur leur S3-like
- Service qui gère le déploiement de l'application
- Service qui gère le cache de build

[NOTE.speaker]
====
====

== Liens

[bibliography]
- [[[libmacaroons]]] _Implémentation de référence_. https://github.com/rescrv/libmacaroons
- [[[pub41892]]] Arnar Birgisson et al. _Macaroons: Cookies with
Contextual Caveats for Decentralized Authorization in the Cloud_. Network and
Distributed System Security Symposium, Internet Society. 2014.
https://research.google.com/pubs/pub41892.html
- [[[cordellBlog]]] Evan Cordell. _Macaroons 101: Contextual Confinement_.
Elegent authorization, for a more civilized age. 2015.
http://evancordell.com/2015/09/27/macaroons-101-contextual-confinement.html

== Merci

- https://twitter.com/{twitter}
- https://github.com/{github}
- {blog}

- https://www.valwin.fr
- On recrute !
