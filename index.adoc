= Stateless authorization and delegation with Macaroons
Julien Tanguy
v1.0, 2017-05-18: Ncrafts 2017
:homepage: https://github.com/jtanguy/macaroons-hands-on
:twitter: jutanguy
:github: jtanguy
:blog: https://jtanguy.cleverapps.io
:backend: revealjs
:copyright: CC BY 4.0
:hashtag: #macaroons
:stem: latexmath
:source-highlighter: highlightjs
:revealjsdir: reveal.js
:revealjs_display: flex
:revealjs_theme: valwin
:title-slide-background-image: images/macaroons.jpg

== Code

[source, shell, subs="attributes, macros"]
----
git clone link:{homepage}[{homepage}]

yarn install
----

[.two-columns]
== `whoami`

image::images/jutanguy.jpg[]

[.align-left]
--
- Web developer
- Functional enthusiast
- First time speaking

//

- https://twitter.com/{twitter}
- https://github.com/{github}
- https://jtanguy.cleverapps.io
--

== Authentication

[quote, https://crypto.stackexchange.com/tags/authentication/info]
____
Authentication is successfully validating that an entity you are communicating
with is actually who they claim to be.
____


== Authorization

[quote]
____
Authorization is according or denying permission to a -- usually authenticated -- user.
____

== Authorization schemes

- ACL linked directly to the user
- Anonymous bearer tokens

== Bearer tokens

[quote]
____
A bearer token is a representation of a set of permissions.
____

== Example permissions

- Viewing a specific file
- View and edit a specific file
- Anything a certain user can do

== Macaroons

- Google research paper published in 2014 <<pub41892>>

- Bearer token with a _signature_
- Decentralized _attenuation_ and _contextual confinment_ with _caveats_

== Anatomy of a macaroon

[frame=none, grid=none]
|===

|*Secret* | Nonce | Secret Key

|*Identifier* | Text/UUID | link to the secret

|*Location* | URL | Location indication of the emitter

|*Signature* 2+| stem:[HMAC(secret,identifier)]
|===

== Code

[source, javascript]
.simple.js
----
include::src/simple.js[tags=frontmatter;simple]
----

=== Result

[source, console]
----
$ node simple.js
m: Simple macaroon
location mayoi
identifier it's a me, Mario
signature 7339954339bb20b9ceeb0cd4fff91f66ddbe6cc824efa49f165cbd950bc1dc1f
----

== Caveats

____
*Ordered* list of _predicates_ which restrict the macaroon's authority
____

Two types of caveats:

- _first party_ caveats, which directly restrict the macaroon's authority, and
- _third party_ caveats, which require additional evidence.


== Computing the signature

The signature is computed by chaining the HMAC operations.

[.step]
. stem:[sig_m = HMAC(secret, identifier)]
. stem:[sig_{m_2} = HMAC(sig_m, c)]
. stem:[sig_{m_3} = HMAC(sig_{m_2}, c_2)]

== Code

[source, javascript]
.simple.js
----
include::src/simple.js[tag=caveats]
----

=== Result

[source, console]
----
$ node simple.js
location mayoi
identifier it's a me, Mario
signature 7339954339bb20b9ceeb0cd4fff91f66ddbe6cc824efa49f165cbd950bc1dc1f

m2: With a caveat c = 'talk = macaroons-hands-on'
location mayoi
identifier it's a me, Mario
cid talk = macaroons-hands-on
signature c247c5613203141be46a14008678a2aaec41d83c9cf69d7b10b5c4e533047abb

m3: With a caveat c2 = 'time < 2017-05-18T14:45+02:00'
location mayoi
identifier it's a me, Mario
cid talk = macaroons-hands-on
cid time < 2017-05-18T14:45+02:00
signature 4bd18fd10c0193ae25fc73ce3f89b46a64ffb6508025ba3faeb5acf2656a99f6
----


== Verifying macaroons

One only need to know the secret and how to verify each caveat



== References

[bibliography]
- [[[pub41892]]] Arnar Birgisson and Joe Gibbs Politz and Ãšlfar Erlingsson and
Ankur Taly and Michael Vrable and Mark Lentczner. Macaroons: Cookies with
Contextual Caveats for Decentralized Authorization in the Cloud. Network and
Distributed System Security Symposium, Internet Society. 2014.
https://research.google.com/pubs/pub41892.html

